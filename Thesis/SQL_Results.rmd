---
title: "SQL_Results"
author: "Chip Lynch"
date: "4/3/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## SQL Network Adequacy Results

We conducted our experiment as described, resulting in 36 combinations of point ($P$) and query ($Q$) sets from the same 150,000 point sample we've used for $NN$ experiments.  The datasets are categorized and range from 100 to 32,000 points, as shown here:

```{r category_counts, echo=FALSE}
library(knitr)
library(data.table)

data <- read.csv('../postgresql/query_timings.csv')
data <- data[data$notes %like% 'Adequ',]

names(data)[3] <- 'timing_s'

cat_data <- unique(data[,c('leftcat', 'leftcount')])
names(cat_data) <- c('category', 'record count')
kable(cat_data, caption="Record counts by category used in experiment")
```

Recall that we are calculating the Network Adequacy Percent (NAP), which requires a distance $d$, and we performed expriments with $d \in (0.1, 1, 10, 100)$.  At a high level, our TRILAT-NA algoritm performs well against the naive algorithm as shown in our "SQL Timings" figure.


```{r sql_results, echo=FALSE, fig.cap="SQL Timings (s) - lower is better", fig.width=6, fig.height=4}
library(data.table)
library(ggplot2)

data <- read.csv('../postgresql/query_timings.csv')
names(data)[3] <- 'timing_s'

data$dist <- 0
data[data$notes %like% 'dist: 0.1','dist'] <- 0.1
data[data$notes %like% 'dist: 1','dist'] <- 1
data[data$notes %like% 'dist: 10','dist'] <- 10
data[data$notes %like% 'dist: 100','dist'] <- 100

data <- data[data$notes %like% 'Adequ',]
data$algorithm = 'None'
data[data$notes %like% 'CatAdequacy','algorithm'] = 'st_distance'
data[data$notes %like% 'CatTrilatAdequacy', 'algorithm'] = 'Trilateration'
# table(data$algorithm)
data <- data[data$algorithm != 'None',]
data$dist <- as.factor(data$dist)

ggplot(data=data, aes(x=dist, y=timing_s, fill=algorithm)) +
    geom_bar(stat='identity', position=position_dodge()) +
    scale_fill_manual(values=gray.colors(4))

```


Given the importance of the sizes of the $P$ and $Q$ datasets, it's quite informative to compare the algorithms with respect to those sizes.

```{r QP_size_comparison_d01, echo=FALSE, message=FALSE, fig.cap="SQL Timings By Category (s) - d=0.1 - lower is better", fig.width=10, fig.height=5}
library(ggplot2)
library(data.table)

data <- read.csv('../postgresql/query_timings.csv')
names(data)[3] <- 'timing_s'

data$dist <- 0
data[data$notes %like% 'dist: 0.1','dist'] <- 0.1
data[data$notes %like% 'dist: 1','dist'] <- 1
data[data$notes %like% 'dist: 10','dist'] <- 10
data[data$notes %like% 'dist: 100','dist'] <- 100

data <- data[data$notes %like% 'Adequ',]
data$algorithm = 'None'
data[data$notes %like% 'CatAdequacy','algorithm'] = 'st_distance'
data[data$notes %like% 'CatTrilatAdequacy', 'algorithm'] = 'Trilateration'
data <- data[data$algorithm != 'None',]
data$dist <- as.factor(data$dist)


library('tidyverse')
data$leftcat <- as.factor(data$leftcat)
data$rightcat <- as.factor(data$rightcat)

data$leftcount <- as.factor(data$leftcount)
data$rightcount <- as.factor(data$rightcount)

plotdata <- aggregate(data$timing_s,
          by = list(data$leftcount, data$rightcount, data$algorithm, data$dist),
          FUN=median)
names(plotdata) <- c('leftcount', 'rightcount', 'algorithm', 'dist', 'timing_s')

library(gridExtra)

mydist=0.1

  p1 <- ggplot(data=plotdata[plotdata$algorithm=='st_distance' & plotdata$dist==mydist,], aes(x=leftcount, y=rightcount)) +
    geom_tile(aes(fill=timing_s)) +
    geom_text(aes(label=trunc(timing_s)), colour="black") +
              # colour="green") +
    # scale_fill_continuous(limits=c(0,1000))
    # scale_fill_gradient(low="black", high="white", limits=c(0,1000)) +
    xlab("|P| - Naive") +
    ylab("|Q|") +
    scale_fill_gradient2(
      low = "red",
      mid = "white",
      high = "blue",
      midpoint = 300, limits=c(0, 1000),
      space = "Lab",
      na.value = "grey50",
      guide = "colourbar",
      aesthetics = "fill"
    )
  
  p2 <-  ggplot(data=plotdata[plotdata$algorithm=='Trilateration' & plotdata$dist==mydist,], aes(x=leftcount, y=rightcount)) +
    geom_tile(aes(fill=timing_s)) +
    geom_text(aes(label=trunc(timing_s)),
              colour="black") +
    xlab("|P| - Trilateration") +
    ylab("|Q|") +
    # scale_fill_gradient(low = "blue", high = "red")
    # scale_fill_continuous(type='viridis', limits=c(0,1000)) +
    # scale_color_gradient(low='green', high='black', limits=c(0, 1000)) +
    # scale_fill_gradient(low="black", high="white", limits=c(0,1000)) +
    scale_fill_gradient2(
      low = "red",
      mid = "white",
      high = "blue",
      midpoint = 300, limits=c(0, 1000),
      space = "Lab",
      na.value = "grey50",
      guide = "colourbar",
      aesthetics = "fill"
    )
    # scale_fill_gradient2(midpoint = 100, low = "blue", mid = "white", high = "red", space = "Lab" )
    # facet_wrap(~notes)
  
  grid.arrange(p1, p2, nrow=1, ncol=2)

```


```{r QP_size_comparison_d1, echo=FALSE, message=FALSE, fig.cap="SQL Timings By Category (s) - d=1 - lower is better", fig.width=10, fig.height=5}
library(ggplot2)
library(data.table)

data <- read.csv('../postgresql/query_timings.csv')
names(data)[3] <- 'timing_s'

data$dist <- 0
data[data$notes %like% 'dist: 0.1','dist'] <- 0.1
data[data$notes %like% 'dist: 1','dist'] <- 1
data[data$notes %like% 'dist: 10','dist'] <- 10
data[data$notes %like% 'dist: 100','dist'] <- 100

data <- data[data$notes %like% 'Adequ',]
data$algorithm = 'None'
data[data$notes %like% 'CatAdequacy','algorithm'] = 'st_distance'
data[data$notes %like% 'CatTrilatAdequacy', 'algorithm'] = 'Trilateration'
data <- data[data$algorithm != 'None',]
data$dist <- as.factor(data$dist)


library('tidyverse')
data$leftcat <- as.factor(data$leftcat)
data$rightcat <- as.factor(data$rightcat)

data$leftcount <- as.factor(data$leftcount)
data$rightcount <- as.factor(data$rightcount)

plotdata <- aggregate(data$timing_s,
          by = list(data$leftcount, data$rightcount, data$algorithm, data$dist),
          FUN=median)
names(plotdata) <- c('leftcount', 'rightcount', 'algorithm', 'dist', 'timing_s')

library(gridExtra)

mydist = 1
  p1 <- ggplot(data=plotdata[plotdata$algorithm=='st_distance' & plotdata$dist==mydist,], aes(x=leftcount, y=rightcount)) +
    geom_tile(aes(fill=timing_s)) +
    geom_text(aes(label=trunc(timing_s)), colour="black") +
              # colour="green") +
    # scale_fill_continuous(limits=c(0,1000))
    # scale_fill_gradient(low="black", high="white", limits=c(0,1000)) +
    xlab("|P| - Naive") +
    ylab("|Q|") +
    scale_fill_gradient2(
      low = "red",
      mid = "white",
      high = "blue",
      midpoint = 100, limits=c(0, 500),
      space = "Lab",
      na.value = "grey50",
      guide = "colourbar",
      aesthetics = "fill"
    )
  
  p2 <-  ggplot(data=plotdata[plotdata$algorithm=='Trilateration' & plotdata$dist==mydist,], aes(x=leftcount, y=rightcount)) +
    geom_tile(aes(fill=timing_s)) +
    geom_text(aes(label=trunc(timing_s)),
              colour="black") +
    xlab("|P| - Trilateration") +
    ylab("|Q|") +
    # scale_fill_gradient(low = "blue", high = "red")
    # scale_fill_continuous(type='viridis', limits=c(0,1000)) +
    # scale_color_gradient(low='green', high='black', limits=c(0, 1000)) +
    # scale_fill_gradient(low="black", high="white", limits=c(0,1000)) +
    scale_fill_gradient2(
      low = "red",
      mid = "white",
      high = "blue",
      midpoint = 100, limits=c(0, 500),
      space = "Lab",
      na.value = "grey50",
      guide = "colourbar",
      aesthetics = "fill"
    )
    # scale_fill_gradient2(midpoint = 100, low = "blue", mid = "white", high = "red", space = "Lab" )
    # facet_wrap(~notes)
  
  grid.arrange(p1, p2, nrow=1, ncol=2)

```


```{r QP_size_comparison_d10, echo=FALSE, message=FALSE, fig.cap="SQL Timings By Category (s) - d=10 - lower is better", fig.width=10, fig.height=5}
library(ggplot2)
library(data.table)

data <- read.csv('../postgresql/query_timings.csv')
names(data)[3] <- 'timing_s'

data$dist <- 0
data[data$notes %like% 'dist: 0.1','dist'] <- 0.1
data[data$notes %like% 'dist: 1','dist'] <- 1
data[data$notes %like% 'dist: 10','dist'] <- 10
data[data$notes %like% 'dist: 100','dist'] <- 100

data <- data[data$notes %like% 'Adequ',]
data$algorithm = 'None'
data[data$notes %like% 'CatAdequacy','algorithm'] = 'st_distance'
data[data$notes %like% 'CatTrilatAdequacy', 'algorithm'] = 'Trilateration'
data <- data[data$algorithm != 'None',]
data$dist <- as.factor(data$dist)


library('tidyverse')
data$leftcat <- as.factor(data$leftcat)
data$rightcat <- as.factor(data$rightcat)

data$leftcount <- as.factor(data$leftcount)
data$rightcount <- as.factor(data$rightcount)

plotdata <- aggregate(data$timing_s,
          by = list(data$leftcount, data$rightcount, data$algorithm, data$dist),
          FUN=median)
names(plotdata) <- c('leftcount', 'rightcount', 'algorithm', 'dist', 'timing_s')

library(gridExtra)

mydist = 10
  p1 <- ggplot(data=plotdata[plotdata$algorithm=='st_distance' & plotdata$dist==mydist,], aes(x=leftcount, y=rightcount)) +
    geom_tile(aes(fill=timing_s)) +
    geom_text(aes(label=trunc(timing_s)), colour="black") +
              # colour="green") +
    # scale_fill_continuous(limits=c(0,1000))
    # scale_fill_gradient(low="black", high="white", limits=c(0,1000)) +
    xlab("|P| - Naive") +
    ylab("|Q|") +
    scale_fill_gradient2(
      low = "red",
      mid = "white",
      high = "blue",
      midpoint = 20, limits=c(0, 100),
      space = "Lab",
      na.value = "grey50",
      guide = "colourbar",
      aesthetics = "fill"
    )
  
  p2 <-  ggplot(data=plotdata[plotdata$algorithm=='Trilateration' & plotdata$dist==mydist,], aes(x=leftcount, y=rightcount)) +
    geom_tile(aes(fill=timing_s)) +
    geom_text(aes(label=trunc(timing_s)),
              colour="black") +
    xlab("|P| - Trilateration") +
    ylab("|Q|") +
    # scale_fill_gradient(low = "blue", high = "red")
    # scale_fill_continuous(type='viridis', limits=c(0,1000)) +
    # scale_color_gradient(low='green', high='black', limits=c(0, 1000)) +
    # scale_fill_gradient(low="black", high="white", limits=c(0,1000)) +
    scale_fill_gradient2(
      low = "red",
      mid = "white",
      high = "blue",
      midpoint = 20, limits=c(0, 100),
      space = "Lab",
      na.value = "grey50",
      guide = "colourbar",
      aesthetics = "fill"
    )
    # scale_fill_gradient2(midpoint = 100, low = "blue", mid = "white", high = "red", space = "Lab" )
    # facet_wrap(~notes)
  
  grid.arrange(p1, p2, nrow=1, ncol=2)

```

```{r QP_size_comparison_d100, echo=FALSE, message=FALSE, fig.cap="SQL Timings By Category (s) - d=100 - lower is better", fig.width=10, fig.height=5}
library(ggplot2)
library(data.table)

data <- read.csv('../postgresql/query_timings.csv')
names(data)[3] <- 'timing_s'

data$dist <- 0
data[data$notes %like% 'dist: 0.1','dist'] <- 0.1
data[data$notes %like% 'dist: 1','dist'] <- 1
data[data$notes %like% 'dist: 10','dist'] <- 10
data[data$notes %like% 'dist: 100','dist'] <- 100

data <- data[data$notes %like% 'Adequ',]
data$algorithm = 'None'
data[data$notes %like% 'CatAdequacy','algorithm'] = 'st_distance'
data[data$notes %like% 'CatTrilatAdequacy', 'algorithm'] = 'Trilateration'
data <- data[data$algorithm != 'None',]
data$dist <- as.factor(data$dist)


library('tidyverse')
data$leftcat <- as.factor(data$leftcat)
data$rightcat <- as.factor(data$rightcat)

data$leftcount <- as.factor(data$leftcount)
data$rightcount <- as.factor(data$rightcount)

plotdata <- aggregate(data$timing_s,
          by = list(data$leftcount, data$rightcount, data$algorithm, data$dist),
          FUN=median)
names(plotdata) <- c('leftcount', 'rightcount', 'algorithm', 'dist', 'timing_s')

library(gridExtra)

mydist = 100
  p1 <- ggplot(data=plotdata[plotdata$algorithm=='st_distance' & plotdata$dist==mydist,], aes(x=leftcount, y=rightcount)) +
    geom_tile(aes(fill=timing_s)) +
    geom_text(aes(label=trunc(timing_s)), colour="black") +
              # colour="green") +
    # scale_fill_continuous(limits=c(0,1000))
    # scale_fill_gradient(low="black", high="white", limits=c(0,1000)) +
    xlab("|P| - Naive") +
    ylab("|Q|") +
    scale_fill_gradient2(
      low = "red",
      mid = "white",
      high = "blue",
      midpoint = 20, limits=c(0, 60),
      space = "Lab",
      na.value = "grey50",
      guide = "colourbar",
      aesthetics = "fill"
    )
  
  p2 <-  ggplot(data=plotdata[plotdata$algorithm=='Trilateration' & plotdata$dist==mydist,], aes(x=leftcount, y=rightcount)) +
    geom_tile(aes(fill=timing_s)) +
    geom_text(aes(label=trunc(timing_s)),
              colour="black") +
    xlab("|P| - Trilateration") +
    ylab("|Q|") +
    # scale_fill_gradient(low = "blue", high = "red")
    # scale_fill_continuous(type='viridis', limits=c(0,1000)) +
    # scale_color_gradient(low='green', high='black', limits=c(0, 1000)) +
    # scale_fill_gradient(low="black", high="white", limits=c(0,1000)) +
    scale_fill_gradient2(
      low = "red",
      mid = "white",
      high = "blue",
      midpoint = 20, limits=c(0, 60),
      space = "Lab",
      na.value = "grey50",
      guide = "colourbar",
      aesthetics = "fill"
    )
    # scale_fill_gradient2(midpoint = 100, low = "blue", mid = "white", high = "red", space = "Lab" )
    # facet_wrap(~notes)
  
  grid.arrange(p1, p2, nrow=1, ncol=2)

```